<?xml version="1.0" encoding="UTF-8" standalone="no" ?>

<!--
// - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - -
// Multi-Phasic Applications: SquirrelJME
//     Copyright (C) 2013-2016 Steven Gawroriski <steven@multiphasicapps.net>
//     Copyright (C) 2013-2016 Multi-Phasic Applications <multiphasicapps.net>
// - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - -
// SquirrelJME is under the GNU Affero General Public License v3+, or later.
// For more information see license.mkd.
// - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - -->

<project name="SquirrelJME" basedir="." default="main">
	
	<!-- Project Root Directory -->
	<property name="sjme.root" value="${basedir}" />
	
	<!-- Current Working Directory -->
	<property name="sjme.pwd" value="${user.dir}" />
	
	<!-- Path separator. -->
	<property name="sjme.ps" value="${path.separator}" />
	
	<!-- JAR prefix. -->
	<property name="sjme.jp" value="${sjme.pwd}/sq" />
	
	<!-- Main Target -->
	<target name="main">
		<fail message="You must specify (os)-(arch) when calling this." />
	</target>
	
	<!-- Clean -->
	<target name="clean"
		depends="cldc-clean,zips-clean,poit-clean,poit-jar-clean">
	</target>
	
	<!-- *********************************************************************
	********************************** META **********************************
	********************************************************************** -->
	
	<!-- Clean a code group -->
	<macrodef name="sjme-group-clean">
		<attribute name="library" />
	
		<sequential>
			<delete file="${sjme.jp}@{library}.jar" />
		</sequential>
	</macrodef>
	
	<!-- Compile a code group. -->
	<macrodef name="sjme-group-compile">
		<attribute name="library" />
		<attribute name="runpath" />
		
		<sequential>
			<mkdir dir="${sjme.pwd}/_@{library}" />
			<javac srcdir="${sjme.root}/@{library}"
				destdir="${sjme.pwd}/_@{library}"
				includeantruntime="false"
				bootclasspath="@{runpath}"
				classpath="@{runpath}">
				<compilerarg value="-source" />
				<compilerarg value="1.7" />
				<compilerarg value="-target" />
				<compilerarg value="1.7" />
			</javac>
		</sequential>
	</macrodef>
	
	<!-- Package a code group. -->
	<macrodef name="sjme-group-jar">
		<attribute name="library" />
		
		<sequential>
			<jar destfile="${sjme.jp}@{library}.jar"
				manifest="${sjme.root}/@{library}/META-INF/MANIFEST.MF"
				filesetmanifest="merge"
				indexMetaInf="true"
				level="9">
				<fileset dir="${sjme.pwd}/_@{library}" />
				<fileset dir="${sjme.root}/@{library}">
					<exclude name="**/*.java" />
				</fileset>
			</jar>
			
			<!-- Clean up after self -->
			<delete dir="${sjme.pwd}/_@{library}" />
		</sequential>
	</macrodef>
	
	<!-- Operating System Build. -->
	<macrodef name="sjme-target">
		<attribute name="os" />
		<attribute name="arch" />
		
		<sequential>
			<java classname=
				"net.multiphasicapps.squirreljme.poit.jar.CrossCompilerMain"
				failonerror="true">
				<arg value="@{os}" />
				<arg value="@{arch}" />
				
				<!-- Always include this -->
				<arg value="${sjme.jp}cldc.jar" />
				
				<!-- Classpath needed for compilation. -->
				<classpath>
					<pathelement location="${sjme.jp}cldc.jar" />
					<pathelement location="${sjme.jp}poit.jar" />
					<pathelement location="${sjme.jp}poit-jar.jar" />
					<pathelement location="${sjme.jp}zips.jar" />
				</classpath>
			</java>
		</sequential>
	</macrodef>
	
	<!-- *********************************************************************
	******************************** TARGETS *********************************
	********************************************************************** -->
	
	<!-- Linux PowerPC -->
	<target name="linux-powerpc" depends="clean,poit-jar-jar">
		<sjme-target os="linux" arch="powerpc" />
	</target>
	
	<!-- *********************************************************************
	******************************* LIBRARIES ********************************
	********************************************************************** -->
	
	<!-- CLDC: Clean -->
	<target name="cldc-clean">
		<sjme-group-clean library="cldc" />
	</target>
	
	<!-- CLDC: Compile -->
	<target name="cldc-compile">
		<sjme-group-compile library="cldc"
			runpath="${sjme.root}/cldc" />
	</target>
	
	<!-- CLDC: JAR -->
	<target name="cldc-jar" depends="cldc-compile">
		<sjme-group-jar library="cldc" />
	</target>
	
	<!-- POIT: Clean -->
	<target name="poit-clean">
		<sjme-group-clean library="poit" />
	</target>
	
	<!-- POIT: Compile -->
	<property name="sjme.poit.cp"
		value="${sjme.jp}cldc.jar${sjme.ps}${sjme.jp}zips.jar" />
	<target name="poit-compile" depends="cldc-jar,zips-jar">
		<sjme-group-compile library="poit"
			runpath="${sjme.poit.cp}" />
	</target>
	
	<!-- POIT: JAR -->
	<target name="poit-jar" depends="poit-compile">
		<sjme-group-jar library="poit" />
	</target>
	
	<!-- POIT (JAR): Clean -->
	<target name="poit-jar-clean">
		<sjme-group-clean library="poit-jar" />
	</target>
	
	<!-- POIT (JAR): Compile -->
	<property name="sjme.poit-jar.cp"
		value="${sjme.poit.cp}${sjme.ps}${sjme.jp}poit-jar.jar" />
	<target name="poit-jar-compile" depends="poit-jar">
		<sjme-group-compile library="poit-jar"
			runpath="${sjme.poit-jar.cp}" />
	</target>
	
	<!-- POIT (JAR): JAR -->
	<target name="poit-jar-jar" depends="poit-jar-compile">
		<sjme-group-jar library="poit-jar" />
	</target>
	
	<!-- ZIPS: Clean -->
	<target name="zips-clean">
		<sjme-group-clean library="zips" />
	</target>
	
	<!-- ZIPS: Compile -->
	<target name="zips-compile" depends="cldc-jar">
		<sjme-group-compile library="zips"
			runpath="${sjme.jp}cldc.jar" />
	</target>
	
	<!-- ZIPS: JAR -->
	<target name="zips-jar" depends="zips-compile">
		<sjme-group-jar library="zips" />
	</target>
</project>

